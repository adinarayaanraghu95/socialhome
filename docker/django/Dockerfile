FROM ubuntu:16.04

# Generate some locales
RUN apt-get update && apt-get install -y locales && rm -rf /var/lib/apt/lists/* \
    && localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
ENV LANG en_US.utf8

# Install OS packages
RUN apt-get update && apt-get install -y \
    # Direct dependencies for socialhome
    git python-virtualenv python3-setuptools python3-dev build-essential libpq-dev \
    # Federation
    libxml2-dev libxslt-dev lib32z1-dev \
    # Redis TODO move to own container
    redis-server \
    # Generic stuff for Ubuntu
    wget apt-transport-https apt-utils

# Add user
RUN groupadd -r socialhome && useradd --no-log-init -r -g socialhome socialhome

# NodeJS
RUN wget --quiet -O - https://deb.nodesource.com/gpgkey/nodesource.gpg.key | apt-key add -
RUN echo "deb https://deb.nodesource.com/node_6.x xenial main" | tee /etc/apt/sources.list.d/nodesource.list
RUN echo "deb-src https://deb.nodesource.com/node_6.x xenial main" | tee -a /etc/apt/sources.list.d/nodesource.list
RUN apt-get update && apt-get install -y nodejs

# Copy the whole app
COPY . /home/socialhome/socialhome

# Ensure user owns everything
RUN chown -R socialhome:socialhome /home/socialhome

# Switch to Socialhome user
USER socialhome
WORKDIR /home/socialhome/socialhome

RUN virtualenv -p /usr/bin/python3 .venv

# Bring in environment variables from compose
ARG DATABASE_URL
ARG DJANGO_SECRET_KEY
ARG DJANGO_ALLOWED_HOSTS
ARG DJANGO_SECURE_SSL_REDIRECT
ARG DJANGO_ACCOUNT_ALLOW_REGISTRATION
ARG SOCIALHOME_DOMAIN
ARG SOCIALHOME_HTTPS
ARG SOCIALHOME_LOGFILE
ARG SOCIALHOME_LOGFILE_FEDERATION
ARG DJANGO_ADMIN_NAME
ARG DJANGO_ADMIN_MAIL
ARG DJANGO_SERVER_EMAIL
ARG DJANGO_OPBEAT_ORGANIZATION_ID
ARG DJANGO_OPBEAT_APP_ID
ARG DJANGO_OPBEAT_SECRET_TOKEN
ARG DJANGO_AWS_ACCESS_KEY_ID
ARG SOCIALHOME_STATISTICS
ARG DJANGO_DEBUG_TOOLBAR
ARG MOCHA_TESTS
ARG DJANGO_SETTINGS_MODULE

ENV DATABASE_URL=$DATABASE_URL
ENV DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY
ENV DJANGO_ALLOWED_HOSTS=$DJANGO_ALLOWED_HOSTS
ENV DJANGO_SECURE_SSL_REDIRECT=$DJANGO_SECURE_SSL_REDIRECT
ENV DJANGO_ACCOUNT_ALLOW_REGISTRATION=$DJANGO_ACCOUNT_ALLOW_REGISTRATION
ENV SOCIALHOME_DOMAIN=$SOCIALHOME_DOMAIN
ENV SOCIALHOME_HTTPS=$SOCIALHOME_HTTPS
ENV SOCIALHOME_LOGFILE=$SOCIALHOME_LOGFILE
ENV SOCIALHOME_LOGFILE_FEDERATION=$SOCIALHOME_LOGFILE_FEDERATION
ENV DJANGO_ADMIN_NAME=$DJANGO_ADMIN_NAME
ENV DJANGO_ADMIN_MAIL=$DJANGO_ADMIN_MAIL
ENV DJANGO_SERVER_EMAIL=$DJANGO_SERVER_EMAIL
ENV DJANGO_OPBEAT_ORGANIZATION_ID=$DJANGO_OPBEAT_ORGANIZATION_ID
ENV DJANGO_OPBEAT_APP_ID=$DJANGO_OPBEAT_APP_ID
ENV DJANGO_OPBEAT_SECRET_TOKEN=$DJANGO_OPBEAT_SECRET_TOKEN
ENV DJANGO_AWS_ACCESS_KEY_ID=$DJANGO_AWS_ACCESS_KEY_ID
ENV SOCIALHOME_STATISTICS=$SOCIALHOME_STATISTICS
ENV DJANGO_DEBUG_TOOLBAR=$DJANGO_DEBUG_TOOLBAR
ENV MOCHA_TESTS=$MOCHA_TESTS
ENV DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE

# Install dependencies
RUN .venv/bin/pip install -U pip setuptools
RUN .venv/bin/pip install -r requirements.txt

# Install and build node stuff
RUN npm install
RUN node_modules/.bin/bower install
RUN node_modules/.bin/grunt build
RUN npm run dev

# Collect statics
RUN .venv/bin/python manage.py collectstatic --no-input

# Run uWSGI
CMD ["/home/socialhome/socialhome/.venv/bin/uwsgi", "--ini", "/home/socialhome/socialhome/docker/django/uwsgi.ini"]

EXPOSE 8000
